## 灰度发布

#### 背景
重大项目重构时常常需要先使用一小部分用户进行线上测试，再慢慢完成切换。按照理想的场景，技术升级方向如以下所示。主要是前一项工作的完善度会减轻之后工作的复杂度。

```
	项目标准化建设 --> 调用链监控 --> 灰度发布 --> 全链路压测
```

#### 组件
流量在客户端或api网关标记带个标签，各中间件会根据流量的标签进行不同的处理。http、rpc、rabbitmq、kafka的流量带有标签，通过调整路由规则，redis、db和es为数据不带有标签，如果与正常业务有影响可以新建影子库。  
一、http流量  
&emsp;&emsp;nginx层判断出标签(支持userId、手机号、白名单或者客户端自带标签等)，并在http header附加该标签，方便后续处理。  

二、dubbo  
&emsp;&emsp;扩展dubbo负载均衡，实现按流量标签实现的负载均衡算法从指定的生产者列表挑选指定的机器进行调用

三、rabbitmq  
&emsp;&emsp;header带有标签
方案一： 生产者写不同的exchange和queue，消费者根据自身的标签监听相应的队列，也可能监听所有队列。
方案二：生产者还是写到同一个队列，消费者要如何处理?

四、kafka  
&emsp;&emsp;header带有标签，原理类似rabbitmq
  
五、redis  
&emsp;&emsp;如果只当缓存使用，是可以统一存放的。  

六、DB  
&emsp;&emsp;如果新旧不兼容需要两套数据库。  

七、elasticsearch
&emsp;&emsp;  